% Chapter Template

\chapter{Diseño e Implementación} % Main chapter title

\label{Chapter3} % Change X to a consecutive number; for referencing this chapter elsewhere, use \ref{ChapterX}

A continuación se describe el \textit{hardware} seleccionado para la extensión del circuito cargador, los criterios tomados en cuenta, el diseño del circuito y su conexión en \ref{sec:hard}. Luego se describe la arquitectura del sistema en \ref{sec:arq} y entra mas en detalle en \ref{sec:firm}, donde muestra un pseudocódigo del \textit{firmware} para explicar su funcionamiento.

%----------------------------------------------------------------------------------------
%	SECTION 1
%----------------------------------------------------------------------------------------
\section{Hardware}
\label{sec:hard}

%-----------------------------------
%	SUBSECTION 1
%-----------------------------------
\subsection{El Panel Solar}
\label{subsec:panel} 
En el mercado existen distintas soluciones comerciales que se ajustan a las necesidades de cada aplicación. Ofrecen garantía limitada de entre 10 y 25 años y eficiencia de hasta 18 \%.
Es importante que los manufacturadores de módulos aseguren un control de calidad en las celdas fotovoltaicas. Estas están clasificadas según los defectos que puedan tener, identificadas con las letras A a la D. Celdas de grado A son aquellas que no presentan defectos visuales y cumplen con las especificaciones de los datos eléctricos \footnote{http://sinovoltaics.com/quality-control/grading-of-solar-cells-a-b-c-d/}.

El sistema fotovoltaico propuesto originalmente esta basado en módulos con voltaje de 12V y 0.5A. Como medida de mitigación de riesgos, se planteó emplear componentes disponibles en el mercado local, y luego de tener en cuenta factores como grado de calidad (A), eficiencia, costos, tiempo de entrega, soporte pos-venta y al ser de Industria Argentina, se seleccionó el \textit{módulo fotovoltaico policristalino de alto rendimiento KS10T} \footnote{http://www.solartec.com.ar/documentos/productos/3-25wp/SOLARTEC-KS10T-v13.pdf} de la figura \ref{fig:ks10t} de SOLARTEC S.A.

Se trata de paneles fabricados en base a celdas de silicio policristalino de alta eficiencia. La eficiencia de estas celdas es superior al 14\%. Sus características se muestran en la tabla \ref{tab:ks10t} y figura \ref{fig:mecanicas}. \footnote{Fuente: SOLARTEC S.A. Todas las distancias están expresadas en mm.}

 \begin{figure}[h!]
	\centering
    \includegraphics[width=0.5\textwidth]{./Figures/panel.png}
    	\caption{Módulo Fotovoltaico policristalino de alto rendimiento KS10T.}
	\label{fig:ks10t}
\end{figure}

\vspace{10px}

\begin{table}[ht]
	\centering
	\caption{Características del módulo fotovoltaico KS10T}
	\begin{tabular}{@{} l *2c @{}}    \toprule
		\emph{\textbf{Características}} & \emph{\textbf{Valor}} & \emph{\textbf{Unidad}}\\
		\midrule
		Potencia nominal	& 10 	& Wp	\\	
		Tensión a PN		& 17.4	& V\\
		Corriente a PN	& 0.58		& A\\
		Dimensiones		& 301x352x22 	& mm\\
		Peso				& 0.58		& Kg	\\
		\bottomrule
		\hline
	\end{tabular}
	\label{tab:ks10t}
\end{table}

\begin{figure}[h!]
	\centering
    \includegraphics[width=0.5\textwidth]{./Figures/mecanicas.JPG}
    	\caption{Características mecánicas.}
	\label{fig:mecanicas}
\end{figure}

La curva de la figura \ref{fig:curva}, muestra la corriente máxima de cortocircuito y la tensión máxima a circuito abierto del \textit{módulo KS10T}. Nótese que es capaz de entregar la tensión hasta exigir el máximo de corriente. Los valores y la curva están dados para condiciones de insolación de 1 KW/m2, masa atmosférica 1.5 y temperatura de celda de 25 \grados C.\footnote{Fuente: SOLARTEC S.A.}

\begin{figure}[h!]
	\centering
    \includegraphics[width=0.5\textwidth]{./Figures/curva.JPG}
    	\caption{Características eléctricas.}
	\label{fig:curva}
\end{figure}

%-----------------------------------
%	SUBSECTION 2
%-----------------------------------
\subsection{Extensión de Circuito Cargador}
\label{subsec:extensión}
Entre las interfaces para el usuario del nodo \textit{Mote LSE} esta el puerto USB, el cual alimenta al circuito de control de carga \textit{bq24080 1-A} con 5V(DC) a través de un conector USB micro-B. Este circuito es el empleado para la carga de la batería de Li-ion de 3.7V y 900mAh.

Es por esto que es necesario emplear una etapa reguladora de voltaje a la salida del panel, para la cual se utiliza el clásico regulador de Fairchild \textit{LM7805} \footnote{https://www.fairchildsemi.com/datasheets/LM/LM7805.pdf} de 1A. Que con unos pocos componentes (un condensador electrolítico como filtro a tierra para señales continuas para moderar la tensión eléctrica y las fluctuaciones de corriente y un condensador de poliéster para filtrar las señales espúreas de alta frecuencia, a la entrada y a la salida) entrega una salida de voltaje entre 4.75V y 5.25V. Además, ofrece protección contra sobrecarga térmica y cortocircuitos y opera entre -40 \grados C y +125 \grados C.

\begin{figure}[h!]
	\centering
    \includegraphics[width=1\textwidth]{./Figures/circuito.jpg}
    	\caption{Diseño de extensión de circuito cargador.}
	\label{fig:circuito}
\end{figure}

Para ver el diseño del PCB de la Extensión de Circuito Cargador, ver \ref{AppendixA}.
%-----------------------------------
%	SUBSECTION 3
%-----------------------------------
\subsection{Diagrama de conexión}
\label{subsec:conexión}

%----------------------------------------------------------------------------------------
%	SECTION 2
%----------------------------------------------------------------------------------------

\section{Arquitectura}
\label{sec:arq}
Cuando se diseña adecuadamente, los drivers del hardware están abstraídos del hardware en sí. Para que los usuarios finales, en este caso desarrolladores de software a nivel de aplicación, puedan controlar el hardware cuando una rutina en particular es llamada con el parámetro apropiado (API-CAPI \footnote{Application Programming Interface - Common Application Programming Interface}). Esto se refiere a la interfaz que las aplicaciones pueden usar para comunicarse directamente con el \textit{Mote LSE}.

APIs, interfaces.

El modelo propuesto consiste en una arquitectura de capas (Ver subsección \ref{subsec:capas}), que incluye varios algoritmos y procedimientos (Ver subsección \ref{subsec:bloques}) que son usados para decidir de forma autónoma el modo de operación, si es necesario cargar la batería y generar alarmas de salud.

%-----------------------------------
%	SUBSECTION 1
%-----------------------------------
\subsection{Modelo de capas}
\label{subsec:capas} 
Los niveles de abstracción 
\begin{figure}[h!]
	\centering
    \includegraphics[width=.8\textwidth]{./Figures/topologia.jpg}
    	\caption{Modelo de Capas del Sistema.}
	\label{fig:capas}
\end{figure}
%-----------------------------------
%	SUBSECTION 2
%-----------------------------------
\subsection{Diagrama en bloques}
\label{subsec:bloques} 
Módulos. 
GPIO configurable al recibir un frame de determinadas características (puede esperar tramas de una serie de direcciones - frame filtering)


%----------------------------------------------------------------------------------------
%	SECTION 3
%----------------------------------------------------------------------------------------
\section{Firmware}
\label{sec:firm}
El software embebido, llamado firmware en adelante, fue implementado en lenguaje de programacion C.

Algunas tareas tienen deadlines, otras pueden no tener o pueden tener poca penalidad si no se cumplen.

%#includes

La funcion main siempre es llamada cuando el programa se ejecuta por primera vez. De ahi se llama a otras funciones

%-----------------------------------
%	SUBSECTION 1
%-----------------------------------
\subsection{Descripción}
\label{subsec:desc} 

Configuración de cada nodo (Parametros y valores)
%Master: %Configurar como MASTER %Parámetros a ingresar %Diagrama de algoritmo
%Device: %Configurar como DEVICE %Parámetros a ingresar %Diagrama de algoritmo

Para cumplir con el requerimiento de almacenar en una memoria no volátil los datos de alarma, parámetros monitoreados, tiempo total de uso, y cantidad de ciclos de carga/descarga, éstos son almacenados en la memoria Flash del microcontrolador (la memoria SRAM necesita energía para que perduren los datos). Para ello se definieron las siguientes variables:
    
%No se programan tareas con prioridades, es decir que la ejecución de una tarea no sera detenida por el procesador, sin prevaciado y no se implementa tail-chaining ni late-arriving.
%Arquitectura RISK. Modelo Hardvard: Buses separados, pero un unico mapa de memoria que esta predefinido por la arquitectura. Permite agrupar a los perifeicos por funcion y prioridad, lo que simplifica el diseno del microcontrolador y optimiza la velocidad de acceso al mismo.
NVIC: Funciones del CMSIS
Primero se usa la funcion del CMSIS, luego se define en codigo el handler de la excepcion correspondiente, en cada entrada del vector se escribe la dirección de memoria del handler asociado a la excepción 

\textit{wait for interrupt} buena practica
%(_WFI)
Como premisa

Para ver una descripción del firmware en pseudocódigo y sus principales funciones, ver \ref{AppendixC}.

%-----------------------------------
%	SUBSECTION 2
%-----------------------------------
\subsection{Funcionalidades por capas}
\label{subsec:func} 
\begin{itemize}
	\item Implementación de funcionalidades en la subcapa MAC

	\item Implementación de funcionalidades en la subcapa PHY

	\item Implementación de funcionalidades a nivel de aplicación
	
\end{itemize}

%-----------------------------------
%	SUBSECTION 3
%-----------------------------------
\subsection{Ajustes a Microstack}
\label{subsec:stack} 

%-----------------------------------
%	SUBSECTION 4
%-----------------------------------
\subsection{Diagramas de Topologías Implementadas}
\label{subsec:topo} 

\begin{figure}[h!]
	\centering
    \includegraphics[width=.8\textwidth]{./Figures/topologia.jpg}
    	\caption{1) Topología estrella. 2)Topología Peer-to-Peer.}
	\label{fig:topo}
\end{figure}

\begin{figure}[h!]
	\centering
    \includegraphics[width=.8\textwidth]{./Figures/cluster.jpg}
    	\caption{Topología árbol de cluster.}
	\label{fig:clust}
\end{figure}



